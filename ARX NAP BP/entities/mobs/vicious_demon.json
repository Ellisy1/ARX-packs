{
	"format_version": "1.20.0",
	"minecraft:entity": {
		"description": {
			"identifier": "arx:vicious_demon",
			"is_spawnable": true,
			"is_summonable": true,
			"properties": {
				"arx:spin": {
					"client_sync": true,
					"type": "bool",
					"default": false
				},
				"arx:rush": {
					"client_sync": true,
					"type": "bool",
					"default": false
				},
				"arx:agressive_rush": {
					"client_sync": true,
					"type": "bool",
					"default": false
				},
				"arx:shield": {
					"client_sync": true,
					"type": "bool",
					"default": false
				},
				"arx:rested": { // Однохнувший ли демон
					"client_sync": true,
					"type": "bool",
					"default": true
				},
				"arx:is_resting": { // Отыдхает ли демон прямо сейчас
					"client_sync": true,
					"type": "bool",
					"default": false
				},
				"arx:hp": {
					"client_sync": true,
					"type": "int",
					"default": 3,
					"range": [
						0,
						3
					] // Четверти хп. 0 = от 0 до 25%, 1 = от 25% до 50% и т.д.
				}
			}
		},
		"components": {
			"minecraft:tick_world": {
				"distance_to_players": 128,
				"never_despawn": true,
				"radius": 2
			},
			"minecraft:navigation.walk": {
				"can_path_over_water": true,
				"avoid_water": false,
				"avoid_damage_blocks": false,
				"avoid_portals": false
			},
			"minecraft:movement.basic": {},
			"minecraft:knockback_resistance": {
				"value": 0.5
			},
			"minecraft:type_family": {
				"family": [
					"vicious",
					"boss",
					"dangerous"
				]
			},
			"minecraft:behavior.look_at_entity": {
				"priority": 20,
				"look_distance": 20,
				"filters": {
					"test": "is_family",
					"subject": "other",
					"value": "player"
				}
			},
			"minecraft:boss": {
				"hud_range": 20,
				"name": "§a§lПорочный демон",
				"should_darken_sky": false
			},
			"minecraft:experience_reward": {
				"on_death": "query.last_hit_by_player ? 1000 : 0"
			},
			"minecraft:loot": {
				"table": "loot_tables/entities/vicious_demon.json"
			},
			"minecraft:is_hidden_when_invisible": {},
			"minecraft:collision_box": {
				"width": 0.6,
				"height": 1.8
			},
			"minecraft:health": {
				"value": 500
			},
			"minecraft:movement": {
				"value": 0.28
			},
			"minecraft:balloonable": {},
			"minecraft:physics": {},
			"minecraft:pushable": {
				"is_pushable": true,
				"is_pushable_by_piston": true
			},
			"minecraft:conditional_bandwidth_optimization": {},
			"minecraft:damage_sensor": {
				"triggers": {
					"on_damage": {
						"event": "increase_hit_counter"
					}
				}
			},
			"minecraft:on_death": {
				"event": "on_death",
				"target": "self"
			}
		},
		"component_groups": {
			// Основная фаза (Спин)
			"spin": {
				"minecraft:timer": {
					"looping": false,
					"time": 10,
					"time_down_event": {
						"event": "stop_spin"
					}
				},
				"minecraft:behavior.nearest_attackable_target": {
					"priority": 2,
					"reselect_targets": true,
					"must_see_forget_duration": 25.0,
					"entity_types": [
						{
							"filters": {
								"all_of": [
									{
										"test": "is_family",
										"subject": "other",
										"value": "player"
									},
									{
										"test": "is_family",
										"subject": "other",
										"operator": "not",
										"value": "is_knocked"
									}
								]
							},
							"max_dist": 1000
						}
					]
				},
				"minecraft:behavior.melee_attack": {
					"priority": 1,
					"speed_multiplier": 1.1
				},
				"minecraft:attack": {
					"damage": 1
				}
			},
			// Основная фаза (Раш)
			"rush": {
				"minecraft:timer": {
					"looping": false,
					"time": 7,
					"time_down_event": {
						"event": "stop_rush"
					}
				},
				"minecraft:behavior.nearest_attackable_target": {
					"priority": 2,
					"reselect_targets": true,
					"must_see_forget_duration": 25.0,
					"entity_types": [
						{
							"filters": {
								"all_of": [
									{
										"test": "is_family",
										"subject": "other",
										"value": "player"
									},
									{
										"test": "is_family",
										"subject": "other",
										"operator": "not",
										"value": "is_knocked"
									}
								]
							},
							"max_dist": 1000
						}
					]
				},
				"minecraft:behavior.melee_attack": {
					"priority": 1,
					"speed_multiplier": 1.7,
					"cooldown_time": 2
				},
				"minecraft:attack": {
					"damage": 7
				}
			},
			// Основная фаза (Агрораш)
			"agressive_rush": {
				"minecraft:timer": {
					"looping": false,
					"time": 5,
					"time_down_event": {
						"event": "stop_agressive_rush"
					}
				},
				"minecraft:behavior.nearest_attackable_target": {
					"priority": 2,
					"reselect_targets": true,
					"must_see_forget_duration": 25.0,
					"entity_types": [
						{
							"filters": {
								"all_of": [
									{
										"test": "is_family",
										"subject": "other",
										"value": "player"
									},
									{
										"test": "is_family",
										"subject": "other",
										"operator": "not",
										"value": "is_knocked"
									}
								]
							},
							"max_dist": 1000
						}
					]
				},
				"minecraft:behavior.melee_attack": {
					"priority": 1,
					"speed_multiplier": 1.9
				},
				"minecraft:attack": {
					"damage": 9
				}
			},
			// Основная фаза (ВЫНУЖДЕННАЯ. Включается при сильном избиении демона)
			"shield": {
				"minecraft:timer": {
					"looping": false,
					"time": 4,
					"time_down_event": {
						"event": "circle_attack"
					}
				},
				"minecraft:knockback_resistance": {
					"value": 1
				}
			},
			// Фаза отдыха (После атак)
			"rest_stage": {
				"minecraft:knockback_resistance": {
					"value": 1
				}
			},
			"rest_stage_cd2s": {
				"minecraft:timer": {
					"looping": false,
					"time": 2,
					"time_down_event": {
						"event": "stop_rest"
					}
				}
			},
			"rest_stage_cd3s": {
				"minecraft:timer": {
					"looping": false,
					"time": 3,
					"time_down_event": {
						"event": "stop_rest"
					}
				}
			},
			"rest_stage_cd4s": {
				"minecraft:timer": {
					"looping": false,
					"time": 5,
					"time_down_event": {
						"event": "stop_rest"
					}
				}
			},
			// Вспомогательное событие (Вернуть отбрасывание)
			"reset_knockback_resistance": {
				"minecraft:knockback_resistance": {
					"value": 0.5
				}
			},
			// Самоуничтожение
			"despawn": {
				"minecraft:instant_despawn": {}
			},
			// Взгляд на цель
			"look_at_player": {
				"minecraft:behavior.look_at_entity": {
					"priority": 20,
					"look_distance": 20,
					"filters": {
						"test": "is_family",
						"subject": "other",
						"value": "player"
					}
				}
			},
			// Новый титл
			"final_boss_title": {
				"minecraft:boss": {
					"hud_range": 20,
					"name": "§c§lПорочный демон - ярость",
					"should_darken_sky": false
				}
			},
			// Пустой таймер
			"empty_timer" :{ 
				"minecraft:timer": {
					"time": 1,
					"looping": false,
					"time_down_event": {
						"event": "arx:none",
						"target": "self"
					}
				}
			}
		},
		"events": {
			// Новый титл
			"final_boss_title": {
				"add": {
					"component_groups": [
						"final_boss_title"
					]
				},
				"set_property": {
					"arx:rested": true
				}
			},
			// Делаем щит
			"shield": {
				"remove": {
					"component_groups": [
						"rush",
						"spin",
						"empty_timer"
					]
				},
				"add": {
					"component_groups": [
						"shield"
					]
				},
				"set_property": {
					"arx:rush": false,
					"arx:agressive_rush": false,
					"arx:spin": false,
					"arx:shield": true,
					"arx:is_resting": false
				},
				"queue_command": {
					"command": [
						"effect @s regeneration 4 3",
						"effect @s resistance 4 255 true"
					]
				}
			},
			// Пробиваем сильную круговую атаку
			"circle_attack": {
				"remove": {
					"component_groups": "shield"
				},
				"add": {
					"component_groups": "reset_knockback_resistance"
				},
				"set_property": {
					"arx:rested": true,
					"arx:shield": false
				},
				"queue_command": {
					"command": [
						"playanimation @s animation.vicious_demon.circle_attack",
						"particle arx:vicious_demon_spawn_flame_outward ~ ~1 ~",
						"particle arx:vicious_flame ~ ~ ~",
						"particle arx:vicious_demon_spawn_flame_outward ~ ~ ~",
						"damage @a[r=5, has_property={arx:is_knocked=false}] 20 entity_attack",
						"scoreboard players add @a[r=5, has_property={arx:is_knocked=false}] vicious_flame 5",
						"event entity @s main_stage_redirect_start"
					]
				}
			},
			// Ударяем магией
			"cast_default_damage_spell": {
				"queue_command": {
					"command": [
						"playanimation @s animation.vicious_demon.cast_default_damage_spell",
						"particle arx:vicious_demon_spawn_flame_outward ~ ~ ~",
						"execute at @p[r=15, has_property={arx:is_knocked=false}] run particle arx:sempra_a ~ ~1 ~",
						"damage @p[r=15, scores={tick_nosempra_a=0, tick_nosempra_b=0, tick_nosempra_c=0}, has_property={arx:is_knocked=false}] 8 entity_attack entity @s",
						"damage @p[r=15, scores={tick_nosempra_a=!0}, has_property={arx:is_knocked=false}] 6 entity_attack entity @s",
						"damage @p[r=15, scores={tick_nosempra_b=!0}, has_property={arx:is_knocked=false}] 4 entity_attack entity @s",
						"damage @p[r=15, scores={tick_nosempra_c=!0}, has_property={arx:is_knocked=false}] 0 entity_attack entity @s",
						"execute if entity @s[has_property={arx:hp=0}] run effect @p[r=15, has_property={arx:is_knocked=false}] levitation 1 1 true",
						"effect @s slowness 1 3 true",
						"playsound dissecting_fog @a ~ ~ ~"
					]
				}
			},
			// Повышаем счётчик полученных ударов
			"increase_hit_counter": {
				"queue_command": {
					"command": [
						"scoreboard players add @s vic_dem_hit_cnt 2"
					]
				}
			},
			// Самоуничтожение
			"despawn": {
				"queue_command": {
					"command": [
						"scoreboard players set @a[scores={verify=2}] vicious_demon 0",
						"particle arx:vicious_demon_spawn_flame_outward ~ ~ ~",
						"execute if entity @a[scores={verify=2, vic_dem_defeated=1}] run fill -204 34 337 -204 36 335 air",
						"fill -191 56 336 -191 56 336 air"
					]
				},
				"add": {
					"component_groups": "despawn"
				}
			},
			// Начинаем отдых
			"start_rest": {
				"add": {
					"component_groups": "rest_stage"
				},
				"remove": {
					"component_groups": "look_at_player"
				},
				"set_property": {
					"arx:is_resting": true
				},
				"queue_command": {
					"command": [
						"event entity @s test_hp",
						"event entity @s[has_property={arx:hp=1}] launch_rest_cd2s",
						"event entity @s[has_property={arx:hp=2}] launch_rest_cd3s",
						"event entity @s[has_property={arx:hp=3}] launch_rest_cd4s",
						"event entity @s[has_property={arx:hp=!1..3}] main_stage_redirect_start" // У нас нет доступной опции для отдыха
					]
				}
			},
			// Заканчиваем отдых
			"stop_rest": {
				"add": {
					"component_groups": [
						"look_at_player",
						"reset_knockback_resistance"
					]
				},
				"set_property": {
					"arx:is_resting": false,
					"arx:rested": true
				},
				"queue_command": {
					"command": [
						"event entity @s main_stage_redirect_start"
					]
				}
			},
			// Вспомогательные события для отдыха
			"launch_rest_cd2s": {
				"add": {
					"component_groups": "rest_stage_cd2s"
				}
			},
			"launch_rest_cd3s": {
				"add": {
					"component_groups": "rest_stage_cd3s"
				}
			},
			"launch_rest_cd4s": {
				"add": {
					"component_groups": "rest_stage_cd4s"
				}
			},
			// I Начинаем фазу атаки с вращением
			"start_spin": {
				"set_property": {
					"arx:spin": true
				},
				"add": {
					"component_groups": "spin"
				}
			},
			// Заканчиваем вращение
			"stop_spin": {
				"remove": {
					"component_groups": "spin"
				},
				"set_property": {
					"arx:spin": false
				},
				"queue_command": {
					"command": [
						"event entity @s main_stage_redirect_start"
					]
				}
			},
			// II Начинаем раш-атаку
			"start_rush": {
				"add": {
					"component_groups": "rush"
				},
				"set_property": {
					"arx:rush": true
				}
			},
			// Оканчиваем раш-атаку
			"stop_rush": {
				"remove": {
					"component_groups": [
						"rush"
					]
				},
				"set_property": {
					"arx:rush": false
				},
				"queue_command": {
					"command": [
						"event entity @s main_stage_redirect_start"
					]
				}
			},
			// III Начинаем агрессивную раш-атаку
			"start_agressive_rush": {
				"add": {
					"component_groups": "agressive_rush"
				},
				"set_property": {
					"arx:agressive_rush": true
				}
			},
			// Оканчиваем агрессивную раш-атаку
			"stop_agressive_rush": {
				"remove": {
					"component_groups": "agressive_rush"
				},
				"set_property": {
					"arx:agressive_rush": false
				},
				"queue_command": {
					"command": [
						"event entity @s main_stage_redirect_start"
					]
				}
			},
			// Драйвер
			// Определяем хп
			"test_hp": {
				"queue_command": {
					"command": [
						"event entity @s test_hp_0_to_25",
						"event entity @s test_hp_25_tp_50",
						"event entity @s test_hp_50_to_75",
						"event entity @s test_hp_75_to_100",
						"execute if entity @s[has_property={arx:hp=0}] run event entity @s final_boss_title"
					]
				}
			},
			"test_hp_0_to_25": {
				"sequence": [
					{
						"filters": {
							"test": "actor_health",
							"operator": "<=",
							"value": 125
						},
						"set_property": {
							"arx:hp": 0
						}
					}
				]
			},
			"test_hp_25_tp_50": {
				"sequence": [
					{
						"filters": {
							"all_of": [
								{
									"test": "actor_health",
									"operator": ">",
									"value": 125
								},
								{
									"test": "actor_health",
									"operator": "<=",
									"value": 250
								}
							]
						},
						"set_property": {
							"arx:hp": 1
						}
					}
				]
			},
			"test_hp_50_to_75": {
				"sequence": [
					{
						"filters": {
							"all_of": [
								{
									"test": "actor_health",
									"operator": ">",
									"value": 250
								},
								{
									"test": "actor_health",
									"operator": "<=",
									"value": 375
								}
							]
						},
						"set_property": {
							"arx:hp": 2
						}
					}
				]
			},
			"test_hp_75_to_100": {
				"sequence": [
					{
						"filters": {
							"test": "actor_health",
							"operator": ">",
							"value": 375
						},
						"set_property": {
							"arx:hp": 3
						}
					}
				]
			},
			// Драйвер - смена фаз атаки
			"main_stage_redirect_start": {
				"queue_command": {
					"command": [
						"event entity @s test_hp",
						"event entity @s main_stage_redirect_step1"
					]
				}
			},
			"main_stage_redirect_step1": {
				"queue_command": {
					"command": [
						"tag @s remove allow_launch_attack_phase", // Чистим данные с прошлой итерации
						"tag @s[has_property={arx:rested=true}] add allow_launch_attack_phase",
						"tag @s[has_property={arx:hp=0}] add allow_launch_attack_phase",
						"execute if entity @s[tag=allow_launch_attack_phase] run function vicious_demon/launch_attack_phase",
						"execute if entity @s[tag=!allow_launch_attack_phase] run event entity @s start_rest",
						"event entity @s main_stage_redirect_step2"
					]
				}
			},
			"main_stage_redirect_step2": {
				"sequence": [
					{
						"filters": {
							"all_of": [
								{
									"test": "has_tag",
									"value": "allow_launch_attack_phase",
									"subject": "self"
								},
								{
									"test": "int_property",
									"value": 0,
									"operator": "not",
									"domain": "arx:hp"
								}
							]
						},
						"set_property": {
							"arx:rested": false
						}
					}
				]
			}
		}
	}
}